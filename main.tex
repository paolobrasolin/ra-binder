% ################################################################ LET'S DANCE #

\documentclass[10pt]{memoir}

% ====================================================================== FONTS =

%\usepackage{mathspec}
%\setmathsfont(Digits,Latin,Greek)
%  [Numbers={Lining,Proportional}]{Linux Libertine O}
\usepackage{fontspec}
\setmainfont{Linux Libertine O}
\setmonofont[Scale=MatchLowercase]{Hack}
\newfontfamily\devanagarifont{Annapurna SIL}
\newfontfamily\displayfont{Linux Libertine Display O}

% ===================================================================== LAYOUT =

\usepackage{calc}

\def\mydeflength#1#2{ % \defLength{name}{value}
 \expandafter\newlength\csname#1\endcsname
 \expandafter\setlength\csname#1\endcsname{#2}}

\mydeflength{qI}{0.25in}  % 1/4 inch
\mydeflength{eI}{0.125in} % 1/8 inch

% ------------------------------------------------------------------- GEOMETRY -

\mydeflength{wL}{5in}     % width
\mydeflength{hL}{8in}     % height
\mydeflength{bL}{0.125in} % bleed
\mydeflength{iL}{0.25in}  % inset
\mydeflength{sL}{0.625in} % spine inset

\setstocksize{\hL+2\bL}{\wL+\bL}
\settrimmedsize{\hL}{\wL}{*}
\settrims{\bL}{\bL}
\setlrmarginsandblock{\sL+\qI}{\iL+\qI}{*}
\setulmarginsandblock{\iL+\qI}{\iL+2\qI}{*}
\setheadfoot{\headheight}{\qI}
\setheaderspaces{0in}{*}{*}
%\setmarginnotes{0in}{0in}{0in}
\checkandfixthelayout
\trimXmarks

% ----------------------------------------------------------------- PAGE STYLE -

\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
    \node[shape=circle,draw,inner sep=1pt,fill=black,white](char){#1};}}

\makepagestyle{main}
\makeevenfoot {main}{}{\raThepage}{}
\makeoddfoot  {main}{}{\raThepage}{}

\aliaspagestyle {chapter}{main}

\NewDocumentCommand\raThepage{}{ % between should not be necessary
  \def\isReality{reality}\ifx\raWorld\isReality{\thepage}\fi%
  \def\isTannaka{tannaka}\ifx\raWorld\isTannaka{\circled{\thepage}}\fi}

\setlength{\parindent}{0.75em}

% ------------------------------------------------------------ CHAPTER HEADING -

\makechapterstyle{ra}{%
  \def\chapterheadstart{\vspace*{3\beforechapskip}}
  \let\printchaptername\relax
  \let\chapternamenum\relax
  \let\printchapternum\relax
  \let\afterchapternum\relax
  \let\printchapternonum\relax
  \def\chaptitlefont{\Huge\displayfont}
  \def\printchaptertitle##1{\raggedleft\parbox{0.8\textwidth}
    {\raggedleft\chaptitlefont ##1}}
  \def\afterchaptertitle{\par\nobreak\vskip 2\afterchapskip}}

\chapterstyle{ra}

% ------------------------------------------------------------------------ TOC -

%\setsecnumdepth{none}
\maxsecnumdepth{none}

\AtBeginDocument{\addtocontents{toc}{\protect\thispagestyle{empty}}} 

\renewcommand{\cftchapterindent}{3\iL}
\renewcommand{\cftchapterfont}{\normalfont} 
\renewcommand{\cftchapterleader}{} 
\renewcommand{\cftchapterformatpnum}{, \itshape}
\renewcommand{\cftchapterafterpnum}{\cftparfillskip} 
\makeatletter
\setlength{\cftbeforechapterskip}{0.5em \@plus\p@}
\makeatother

% ============================================================= DRAFTING TOOLS =

\iftrue

%\usepackage[driver=none,pass,showframe]{geometry}
%\overfullrule=20pt
\usepackage{lipsum}

\usepackage{eso-pic}
\usepackage{tikzpagenodes}

\makeatletter
\newcommand\drawguides{%
  \begin{tikzpicture}[overlay,remember picture,dotted]
    \coordinate (size ref) at (\ifodd\c@page{  0}\else{-\bL}\fi,-\bL);
    \coordinate (trim ref) at (                               0,   0);
    \coordinate (safe ref) at (\ifodd\c@page{\sL}\else{ \iL}\fi, \iL);
    \draw[black]   (size ref) rectangle ++(\wL+\bL,\hL+2\bL);
    \draw[red]     (trim ref) rectangle ++(\wL,\hL);
    \draw[magenta] (safe ref) rectangle ++(\wL-\iL-\sL,\hL-2\iL);
    \begin{scope}[even odd rule, gray]
      \fill (trim ref) rectangle ++(\wL,\hL)
            (size ref) rectangle ++(\wL+\bL,\hL+2\bL);
    \end{scope}
  \end{tikzpicture}}
\makeatother

\AddToShipoutPicture{\drawguides}

\fi

% =================================================================== LANGUAGE =

\usepackage{polyglossia}
\setmainlanguage{british}

\hyphenation{mne-monic vi-ol-ently bog-gling ac-cur-acy kilo-thaum rap-idly
  evid-ence tri-umphantly be-wildered fall-ingi haemo-globin}

% =================================================================== CHAPTERS =

\def\chapterlist{%
%  |city|Thaumic city|,
%  |sufficiently|Sufficiently advanced technology|,
%  |ignorance|{From~ignorance, lead~me~to~truth}|,
%  |isnt|Magic isn’t|,
%  |know|What you don’t know|,
%  |ragdoll|Ragdoll physicist|,
%  |broken|Broken ʼverse|,
%  |thaumonuclear|Thaumonuclear|,
%  |jesus|The Jesus machine|,
%  |space|Space magic|,
  |yantra|The~seventh impossible~thing|,
%  |daemons|Daemons|,
%  |abstract|Abstract weapon|,
%  |death|Death~surrounds this~machine|,
%  |zero|Zero day|,
%  |aum|{\devanagarifont ॐ}|,
%  |bare|Bare metal|,
%  |people|Hatt’s people|,
%  |deeper|Deeper magic|,
%  |cabal|There is no Cabal|,
%  |protagonism|Protagonism|,
%  |scrap|Scrap brain zone|,
%  |inferno|Inferno|,
%  |darkness|{From~darkness, lead~me~to~light}|,
%  |direct|Direct sunlight|,
%  |war|Abstract war|,
%  |real|Everything is real|,
%  |hate|Why do you hate Ra|,
%  |thursdayism|Last thursdayism|,
%  |akheron|Akheron|,
%  |all|All hell|,
%  |rajesh|{From~death, lead~me~to~immortality}|,
%  |machine|Machine space|,
%  |work|It has to work|,
%  |just|Why not just|,
  |destructor|Destructor|}

\def\makechapter|#1|#2|{\chapter{#2}\input{chapters/#1}}

% ===================================================================== CETERA =

\usepackage{xparse}

\let\raEmph\emph
\let\raLatex\LaTeX
\newcommand\raFix[1]{{\color{red}#1}}
\newcommand\raMath[1]{{\color{orange}$#1$}}
\newcommand\raMagic[1]{{\color{purple}\ttfamily\bfseries#1}}

\tikzset{pics/.cd,
  sun symbol/.style={code={
    \fill circle (#1/4);
    \draw[line width=#1/8] circle (#1);}},
  black sun symbol/.style={code={
    \draw[line width=#1*11/16] circle (#1*19/32);}},
  reality symbol/.style={code={
    \pic{sun symbol=1ex};}},
  between symbol/.style={code={
    \pic at (-1ex*19/32,0) {sun symbol=1ex};
    \pic at (1ex*19/32,0) {black sun symbol=1ex};}},
  tannaka symbol/.style={code={
    \pic{black sun symbol=1ex};}}
}

\NewDocumentCommand\raGo{sm}{%
  \IfBooleanF{#1}{
    \Needspace*{5\baselineskip}%
    \nointerlineskip\bigskip%
    \begingroup\centering%
    \noindent\tikz{\pic{#2 symbol}}\par%
    \endgroup%
    \bigskip\nointerlineskip%
  }\gdef\raWorld{#2}}

% ##############################################################################
% ##############################################################################

\usepackage[final]{microtype}

\begin{document} % ################################################ BOOK START #
  \frontmatter % ========================================== PRELIMINARY MATTER =
    \pagestyle{empty}
    \null % ------------------------------------------------------------- leaf -
    \cleartorecto % ----------------------------------------------- HALF TITLE -
    \begingroup\centering
      \vspace*{\fill}\includegraphics[height=40pt]{glyph}\par
    \endgroup
    \cleartorecto % ----------------------------------------------- TITLE PAGE -
    \begingroup\centering
      \null\bigskip
      {\huge Sam Hughes}\par
      \bigskip
      {\fontsize{50pt}{0}\displayfont ra}\par
      \vfill
      \tikz{\pic{sun symbol=1in}}\par
      \vfill
    \endgroup
    \clearpage % -------------------------------------------- TITLE PAGE VERSO -
    \begingroup\centering
      \vspace*{\fill}
      {September 2015}\par
      {Limited edition of a single copy}\par
      \bigskip
      \emph{Dedicato alla luce che effondi}\par
      \vfill\vfill\vfill
      {{\ttfamily ra} © Sam Hughes 2011--14}\par
      {Cover images courtesy of {\scshape nasa}}\par
      {Editing and typesetting by Paolo al-Imk\=an\=\i\ Brasolin}\par
    \endgroup
    \cleartorecto % ------------------------------------------------- CONTENTS -
    \tableofcontents*
  \mainmatter % ==================================================== MAIN TEXT =
    \pagestyle{main}
    \foreach \chap in \chapterlist {\expandafter\makechapter\chap}
  \backmatter % =================================================== END MATTER =
    \pagestyle{empty}
    \cleartorecto\cleartoverso % ------------------------------------ COLOPHON -
    \begin{vplace}[0.5]
      \centering
      This book has been designed 
      Printed in \ldots
    \end{vplace}
    \cleartoverso % ----------------------------------------------------- leaf -
    \null
\end{document} % #################################################### BOOK END #

% ######################################################################## EOF #
